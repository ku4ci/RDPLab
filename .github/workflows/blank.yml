name: üöÄ RDP Lab
on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Durasi penggunaan'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  RDP-Lab-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      # BANNER AWAL
      - name: üéØ INISIALISASI SISTEM
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ü§ñ RDP SERVER UNTUK LAB" -ForegroundColor Yellow
          Write-Host "‚ö° Berjalan di GitHub Actions" -ForegroundColor Green
          Write-Host "üïí Durasi: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          
          # Efek loading
          $frames = @('‚£æ', '‚£Ω', '‚£ª', '‚¢ø', '‚°ø', '‚£ü', '‚£Ø', '‚£∑')
          for($i=0; $i -lt 10; $i++) {
              Write-Host "`rüöÄ Sedang menginisialisasi sistem... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ Sistem sudah siap!                    " -ForegroundColor Green

      # KONFIGURASI RDP
      - name: üîß KONFIGURASI SISTEM
        run: |
          Write-Host ""
          Write-Host "üõ†Ô∏è  SEDANG MELAKUKAN KONFIGURASI SISTEM" -ForegroundColor Yellow
          
          $steps = @(
              @{Name="Mengaktifkan Remote Desktop"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="Menonaktifkan Network Level Authentication"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Mengatur parameter keamanan RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Membuka port 3389 di Windows Firewall"; Script={
                  netsh advfirewall firewall add rule name="RDP-Lab" dir=in action=allow protocol=TCP localport=3389 profile=any
                  netsh advfirewall firewall add rule name="RDP-Lab-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
              }},
              @{Name="Memulai layanan RDP"; Script={
                  Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                  Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "‚îÇ üìã $($step.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - Melewati error minor (aman diabaikan)" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 500
          }
          
          Write-Host "üéØ Konfigurasi selesai!" -ForegroundColor Green

      # BUAT USER RDP GENERIC
      - name: üë§ MEMBUAT AKUN RDP
        run: |
          Write-Host ""
          Write-Host "üë§ SEDANG MEMBUAT AKUN RDP" -ForegroundColor Yellow
          
          # Fungsi untuk membuat password 8 karakter dengan minimal 1 huruf besar, 1 huruf kecil, 1 angka
          function New-LabPassword {
              param()
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'   # hilangkan I,O biar ga gampang ketukar
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'               # hilangkan 0,1 biar ga ketukar
              $all = $upper + $lower + $numbers

              # wajib 1 huruf besar, 1 huruf kecil, 1 angka
              $pw = ''
              $pw += $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]

              # tambahin karakter random sampai 8
              for ($i = 1; $i -le 5; $i++) {
                  $pw += $all[(Get-Random -Minimum 0 -Maximum $all.Length)]
              }

              # acak posisi karakter
              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }

          # Kalau ada password custom dari env, pakai itu
          if ($env:CUSTOM_RDP_PASS) {
              $password = $env:CUSTOM_RDP_PASS
              Write-Host "‚îÇ ‚ÑπÔ∏è  Menggunakan password kustom dari environment variable" -ForegroundColor Blue
          } else {
              $password = New-LabPassword
          }

          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Hapus user lama kalau ada
          try {
              Remove-LocalUser -Name "RDP-USER" -ErrorAction SilentlyContinue
              Write-Host "‚îÇ ‚úÖ User lama dihapus (jika ada)" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ÑπÔ∏è  Tidak ada user lama yang perlu dihapus" -ForegroundColor Blue
          }
          
          # Buat user baru dengan hak yang diperlukan
          try {
              New-LocalUser -Name "RDP-USER" -Password $securePass -AccountNeverExpires -Description "Akun RDP Lab"
              Write-Host "‚îÇ ‚úÖ Akun user baru berhasil dibuat" -ForegroundColor Green
              
              # Set password tidak pernah expired
              try {
                  Set-LocalUser -Name "RDP-USER" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
              } catch {
                  # abaikan kalau cmdlet tidak tersedia
              }

              # Tambah ke grup yang perlu
              Add-LocalGroupMember -Group "Administrators" -Member "RDP-USER" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP-USER" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Users" -Member "RDP-USER" -ErrorAction SilentlyContinue
              
              # Enable user
              Enable-LocalUser -Name "RDP-USER"
              
              Write-Host "‚îÇ ‚úÖ Hak Administrator & Remote Desktop telah diberikan" -ForegroundColor Green
              
          } catch {
              Write-Host "‚îÇ ‚ùå Gagal membuat user: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
          }
          
          # Simpan info ke environment (hindari mengekspos langsung di repo publik)
          echo "RDP_USER=RDP-USER" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV
          echo "$password" > $env:TEMP\rdp_password.txt
          
          Write-Host "‚úÖ Akun RDP (RDP-USER) sudah siap digunakan" -ForegroundColor Green

      # CEK HAK AKSES
      - name: üîç CEK HAK AKSES SISTEM
        run: |
          Write-Host ""
          Write-Host "üîç MEMERIKSA HAK AKSES LOGIN" -ForegroundColor Yellow
          
          # Cek ketersediaan user
          $user = Get-LocalUser -Name "RDP-USER" -ErrorAction SilentlyContinue
          if ($user) {
              Write-Host "‚îÇ ‚úÖ User RDP-USER ditemukan" -ForegroundColor Green
              Write-Host "‚îÇ üìä Status Aktif: $($user.Enabled)" -ForegroundColor White
          } else {
              Write-Host "‚îÇ ‚ùå User tidak ditemukan" -ForegroundColor Red
              exit 1
          }
          
          # Cek hak Administrator
          $isAdmin = (Get-LocalGroupMember -Group "Administrators" | Where-Object {$_.Name -like "*RDP-USER"}).Count -gt 0
          if ($isAdmin) {
              Write-Host "‚îÇ ‚úÖ Memiliki hak akses Administrator" -ForegroundColor Green
          } else {
              Write-Host "‚îÇ ‚ùå Tidak memiliki hak akses Administrator" -ForegroundColor Red
          }
          
          # Cek hak Remote Desktop
          $isRDPUser = (Get-LocalGroupMember -Group "Remote Desktop Users" | Where-Object {$_.Name -like "*RDP-USER"}).Count -gt 0
          if ($isRDPUser) {
              Write-Host "‚îÇ ‚úÖ Terdaftar dalam grup Remote Desktop Users" -ForegroundColor Green
          } else {
              Write-Host "‚îÇ ‚ùå Tidak terdaftar dalam grup Remote Desktop Users" -ForegroundColor Red
          }
          
          # Cek service RDP
          $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
          if ($termService.Status -eq 'Running') {
              Write-Host "‚îÇ ‚úÖ Layanan TermService sedang berjalan" -ForegroundColor Green
          } else {
              Write-Host "‚îÇ ‚ùå Layanan TermService tidak berjalan" -ForegroundColor Red
          }
          
          Write-Host "üéØ Pengecekan sistem selesai!" -ForegroundColor Green

      # KONFIGURASI TAILSCALE (JARINGAN)
      - name: üåê KONFIGURASI JARINGAN (TAILSCALE)
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "üåê SEDANG MENGKONFIGURASI JARINGAN TAILSCALE" -ForegroundColor Yellow
          
          # Install Tailscale
          try {
              $msiPath = "$env:TEMP\tailscale-setup.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
              Write-Host "‚îÇ ‚úÖ Tailscale berhasil diinstal" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ùå Gagal menginstal Tailscale" -ForegroundColor Red
          }
          
          # Tunggu service jalan
          Start-Sleep -Seconds 10
          
          # Login dan hubungkan ke Tailscale
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=rdp-lab-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
              Write-Host "‚îÇ ‚úÖ Berhasil terhubung ke jaringan Tailscale" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ùå Gagal terhubung ke jaringan Tailscale" -ForegroundColor Red
          }
          
          # Ambil IP Tailscale (dengan mekanisme retry)
          Write-Host "üîÑ Sedang mengambil alamat IP..." -NoNewline -ForegroundColor Blue
          $ip = $null
          for($i=0; $i -lt 20; $i++) {
              try {
                  $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                  if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                      echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                      Write-Host "`r‚úÖ Alamat IP: $ip" -ForegroundColor Green
                      break
                  }
              } catch {
                  # abaikan error, coba lagi
              }
              Write-Host "`rüîÑ Sedang mengambil alamat IP... $(@('.', '..', '...')[$i % 3])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Seconds 3
          }
          
          if (-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$') {
              Write-Host "`r‚ö†Ô∏è  Gagal mendapatkan IP Tailscale, menggunakan fallback ke localhost" -ForegroundColor Yellow
              echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
          }

      # TAMPILKAN INFO KONEKSI
      - name: üéâ INFORMASI KONEKSI
        run: |
          $password = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          if (-not $password) {
              $password = "Tidak dapat membaca password"
          }
          
          # Konversi durasi input ke menit
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "1h" { $totalMinutes = 60; $displayTime = "1 jam" }
              "3h" { $totalMinutes = 180; $displayTime = "3 jam" }
              "5h40m" { $totalMinutes = 340; $displayTime = "5 jam 40 menit" }
          }
          
          # Hitung waktu mulai & selesai (zona waktu WIB / SE Asia)
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $waktuMulai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $waktuSelesai = $waktuMulai.AddMinutes($totalMinutes)
          
          Write-Host ""
          Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ            üéâ RDP LAB SIAP DIPAKAI!           ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üåê  Alamat IP: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "‚îÇ üë§  Username : RDP-USER" -ForegroundColor White
          Write-Host "‚îÇ üîê  Password : $password" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞  Durasi   : $displayTime" -ForegroundColor White
          Write-Host "‚îÇ üïê  Mulai    : $($waktuMulai.ToString('HH:mm:ss')) WIB" -ForegroundColor White
          Write-Host "‚îÇ üïê  Selesai  : $($waktuSelesai.ToString('HH:mm:ss')) WIB" -ForegroundColor White
          Write-Host "‚îÇ üìç  Port     : 3389" -ForegroundColor White
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üí°  Panduan Koneksi:                          ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îÇ   1. Buka aplikasi Remote Desktop Connection  ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   2. Masukkan alamat IP: $env:TAILSCALE_IP    ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   3. Login dengan Username & Password di atas ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   4. RDP Lab siap kamu gunakan üöÄ             ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan
          
          # Simpan total menit ke env
          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      # JAGA SESSION TETAP HIDUP SELAMA TEST
      - name: ‚è≥ MENJAGA SESI TETAP AKTIF
        run: |
          $password = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          $totalMinutes = $env:TOTAL_MINUTES
          
          # Hitung waktu mulai & selesai
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $waktuMulai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $waktuSelesai = $waktuMulai.AddMinutes($totalMinutes)
          
          Write-Host ""
          Write-Host "üîÑ MULAI MENJAGA SESI TETAP AKTIF..." -ForegroundColor Yellow
          Write-Host "üíé Status : RDP LAB AKTIF" -ForegroundColor Magenta
          Write-Host "üîó Koneksi: $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "üïê Mulai  : $($waktuMulai.ToString('HH:mm:ss')) WIB" -ForegroundColor Green
          Write-Host "üïê Selesai: $($waktuSelesai.ToString('HH:mm:ss')) WIB" -ForegroundColor Green
          Write-Host ""
          
          # Script pemantauan (monitoring)
          $monitorScript = {
              $lastLogTime = Get-Date
              while ($true) {
                  $currentTime = Get-Date
                  
                  # Log status tiap 2 menit
                  if (($currentTime - $lastLogTime).TotalMinutes -ge 2) {
                      $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                      $rdpConnections = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Where-Object {$_.State -eq 'Established'}
                      
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] üìä Status RDP: $($termService.Status) | Koneksi aktif: $($rdpConnections.Count)" -ForegroundColor Blue
                      $lastLogTime = $currentTime
                  }
                  
                  # Jika layanan RDP mati, coba restart
                  $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  if ($termService.Status -ne 'Running') {
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] üîÑ Merestart layanan TermService..." -ForegroundColor Yellow
                      Start-Service -Name TermService -ErrorAction SilentlyContinue
                  }
                  
                  Start-Sleep -Seconds 30
              }
          }
          
          # Jalankan proses pemantauan di latar belakang
          Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"
          
          # Timer utama
          $frames = @('‚†ã', '‚†ô', '‚†π', '‚†∏', '‚†º', '‚†¥', '‚†¶', '‚†ß', '‚†á', '‚†è')
          $colors = @('Red', 'Yellow', 'Green', 'Cyan', 'Blue', 'Magenta')
          $startTime = Get-Date
          
          do {
              $waktuSekarang = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $sisaWaktu = $waktuSelesai - $waktuSekarang
              
              $sisaJam = [math]::Max(0, [math]::Floor($sisaWaktu.TotalHours))
              $sisaMenit = [math]::Max(0, [math]::Floor($sisaWaktu.TotalMinutes % 60))
              $sisaDetik = [math]::Max(0, [math]::Floor($sisaWaktu.TotalSeconds % 60))
              
              $frame = $frames[([int]((Get-Date) - $startTime).TotalSeconds) % $frames.Length]
              $color = $colors[([int]((Get-Date) - $startTime).TotalMinutes) % $colors.Length]
              
              Write-Host "`r$frame [$($waktuSekarang.ToString('HH:mm:ss'))] Sisa durasi lab: $sisaJam jam $sisaMenit menit $sisaDetik detik" -NoNewline -ForegroundColor $color
              
              Start-Sleep -Seconds 5
              
          } while ($sisaWaktu.TotalSeconds -gt 0)
          
          Write-Host ""
          Write-Host "üéØ WAKTU HABIS - SESI LAB OTOMATIS DIHENTIKAN!" -ForegroundColor Red
          
          # Hentikan background job monitor
          Get-Job -Name "SystemMonitor" -ErrorAction SilentlyContinue | Stop-Job -PassThru | Remove-Job -Force

      # BERSIHKAN SESUDAH SELESAI
      - name: üßπ PEMBERSIHAN SISTEM
        if: always()
        run: |
          Write-Host ""
          Write-Host "üßπ SEDANG MEMBERSIHKAN SISTEM..." -ForegroundColor Yellow
          
          $cleanupSteps = @(
              @{Name="Menghapus file password"; Script={
                  Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
              }},
              @{Name="Menonaktifkan user RDP Lab"; Script={
                  Disable-LocalUser -Name "RDP-USER" -ErrorAction SilentlyContinue
              }},
              @{Name="Memutuskan jaringan Tailscale"; Script={
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
                  Start-Sleep -Seconds 5
              }},
              @{Name="Menghapus rule Firewall RDP"; Script={
                  netsh advfirewall firewall delete rule name="RDP-Lab" dir=in -ErrorAction SilentlyContinue
                  netsh advfirewall firewall delete rule name="RDP-Lab-Out" dir=out -ErrorAction SilentlyContinue
                  Remove-NetFirewallRule -DisplayName "RDP-Lab" -ErrorAction SilentlyContinue
                  Remove-NetFirewallRule -DisplayName "RDP-Lab-Out" -ErrorAction SilentlyContinue
              }},
              @{Name="Mengembalikan konfigurasi bawaan RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
                  Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $cleanupSteps) {
              Write-Host "‚îÇ üóëÔ∏è  $($step.Name)..." -NoNewline -ForegroundColor Gray
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - Ditangani dengan aman" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 300
          }
          
          # Bersihkan sisa job di background
          Get-Job | Stop-Job -PassThru | Remove-Job -Force -ErrorAction SilentlyContinue
          
          Write-Host ""
          Write-Host "üéâ Pembersihan sistem selesai! Sampai jumpa di Lab berikutnya! üëã" -ForegroundColor Green
